{% extends 'store/base.html' %}

{% block title %}{{ product.name }} - Zakir Shop{% endblock %}

{% block content %}
<div class="product-detail-container" style="width:100%; padding:20px;">


    <!-- Top Section: Images + Info -->
    <div class="product-top" style="display:flex; flex-wrap:wrap; gap:40px;">

        <!-- Image Gallery -->
        <div class="product-images" style="flex:1 1 400px; min-width:300px;">
            <div class="main-image" style="border:1px solid #ddd; padding:10px; border-radius:10px;">
                {% if product.image %}
                    <img id="main-img" src="{{ product.image.url }}" alt="{{ product.name }}"
                         style="width:100%; height:400px; object-fit:contain;">
                {% else %}
                    <div style="width:100%; height:400px; display:flex; align-items:center; justify-content:center; background:#f5f5f5;">
                        No Image Available
                    </div>
                {% endif %}
            </div>

            {% if product.gallery.all %}
            <div class="thumbnail-row" style="display:flex; gap:10px; margin-top:10px; flex-wrap:wrap;">
                {% for img in product.gallery.all %}
                    <img src="{{ img.image.url }}" alt="Thumbnail"
                         style="width:60px; height:60px; object-fit:cover; cursor:pointer; border:1px solid #ddd; border-radius:5px;"
                         onclick="document.getElementById('main-img').src='{{ img.image.url }}'">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Product Info -->
        <div class="product-info" style="flex:1 1 400px; min-width:300px;">
            <h1 style="font-size:28px; font-weight:bold;">{{ product.name }}</h1>

            {% if product.discount_price %}
                <p style="font-size:22px; margin:10px 0;">
                    <span style="text-decoration:line-through; color:#888;">KWD {{ product.price }}</span>
                    <span style="color:#e53935; font-weight:bold; margin-left:10px;">KWD {{ product.discount_price }}</span>
                </p>
            {% else %}
                <p style="font-size:22px; margin:10px 0;">KWD {{ product.price }}</p>
            {% endif %}

            {% if product.stock > 0 %}
                <span style="color:#388e3c; font-weight:bold;">In Stock</span>
            {% else %}
                <span style="color:#d32f2f; font-weight:bold;">Out of Stock</span>
            {% endif %}

            {% if product.brand %}
                <p style="margin-top:10px;"><strong>Brand:</strong> {{ product.brand.name }}</p>
            {% endif %}

            {% if product.rating %}
                <p>
                    Rating:
                    {% for i in "12345"|slice:":product.rating"|make_list %}
                        ‚≠ê
                    {% endfor %}
                    ({{ product.reviews.count }} reviews)
                </p>
            {% endif %}

            <div style="margin:20px 0;">
                {% if product.stock > 0 %}
                    {% if request.user.is_authenticated %}
                        <form method="post" action="{% url 'add_to_cart' product.id %}" style="display:flex; align-items:center; gap:10px;">
                            {% csrf_token %}
                            <label for="qty_detail">Qty:</label>
                            <input type="number" name="quantity" id="qty_detail" value="1" min="1" style="width:70px; padding:5px;">
                            <button type="submit" class="btn-primary" style="padding:10px 20px;">Add to Cart</button>
                        </form>
                    {% else %}
                        <a href="{% url 'login' %}" class="btn-primary" style="padding:10px 20px;">Login to Add to Cart</a>
                    {% endif %}
                {% else %}
                    <button class="btn-disabled" disabled style="padding:10px 20px;">Out of Stock</button>
                {% endif %}
            </div>

            <!-- Social Sharing -->
            <div style="margin-top:20px;">
                <p>Share:</p>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank">Facebook</a> |
                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}" target="_blank">Twitter</a> |
                <a href="https://wa.me/?text={{ request.build_absolute_uri }}" target="_blank">WhatsApp</a>
            </div>
        </div>
    </div>

    <!-- Tabs: Description | Reviews | Specs -->
    <div class="product-tabs" style="margin-top:50px;">
        <div style="display:flex; gap:20px; border-bottom:2px solid #ddd;">
            <button onclick="showTab('desc')" class="tab-btn active">Description</button>
            <button onclick="showTab('reviews')" class="tab-btn">Reviews ({{ product.reviews.count }})</button>
            {% if product.specs %}
                <button onclick="showTab('specs')" class="tab-btn">Specifications</button>
            {% endif %}
        </div>

        <div id="desc" class="tab-content" style="margin-top:20px; display:block;">
            {{ product.description|linebreaks }}
        </div>

        <div id="reviews" class="tab-content" style="margin-top:20px; display:none;">
            {% for review in product.reviews.all %}
                <div style="border-bottom:1px solid #eee; padding:10px 0;">
                    <strong>{{ review.user.username }}</strong> - {{ review.rating }}/5
                    <p>{{ review.comment }}</p>
                </div>
            {% empty %}
                <p>No reviews yet.</p>
            {% endfor %}
        </div>

        {% if product.specs %}
        <div id="specs" class="tab-content" style="margin-top:20px; display:none;">
            <ul>
                {% for key, value in product.specs.items %}
                    <li><strong>{{ key }}:</strong> {{ value }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Recently Viewed / You May Also Like -->
    {% if recently_viewed %}
    <div class="recently-viewed" style="margin-top:50px;">
        <h2>You May Also Like</h2>
        <div style="display:flex; overflow-x:auto; gap:15px; padding:10px 0;">
            {% for p in recently_viewed %}
                <div class="card" style="flex:0 0 180px; border:1px solid #eee; border-radius:10px; padding:10px; min-width:180px;">
                    {% if p.image %}
                        <img src="{{ p.image.url }}" alt="{{ p.name }}" style="width:100%; height:150px; object-fit:cover; border-radius:5px;">
                    {% else %}
                        <div style="width:100%; height:150px; background:#f5f5f5; display:flex; align-items:center; justify-content:center;">No Image</div>
                    {% endif %}
                    <p>{{ p.name }}</p>
                    <p>KWD {{ p.price }}</p>
                    <a href="{% url 'product_detail' p.id %}" class="btn-small" style="display:inline-block; margin-top:5px; padding:5px 10px; background:#0073e6; color:white; border-radius:5px; text-align:center;">View</a>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
function showTab(tabId){
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(t=> t.style.display='none');
    document.getElementById(tabId).style.display='block';

    const btns = document.querySelectorAll('.tab-btn');
    btns.forEach(b=> b.classList.remove('active'));
    event.target.classList.add('active');
}
</script>

<style>
.tab-btn {
    padding:10px 15px;
    border:none;
    background:none;
    cursor:pointer;
    font-weight:bold;
}
.tab-btn.active {
    border-bottom:2px solid #0073e6;
    color:#0073e6;
}
.btn-primary {
    background:#0073e6; color:white; border:none; border-radius:5px; cursor:pointer;
}
.btn-disabled { background:#aaa; color:white; border:none; border-radius:5px; }
</style>

{% endblock %}
