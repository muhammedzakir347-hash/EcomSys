{% extends 'store/base.html' %}
{% load static %}

{% block title %}Products - Zakir Shop{% endblock %}

{% block content %}

<div class="product-page-layout">

    <!-- ========== FILTER SIDEBAR (DESKTOP) ========== -->
    <form method="get" class="filters-card desktop-filters">
        <h2 class="filters-title">Filters</h2>

        {% if current_brand_slug %}
            <input type="hidden" name="brand" value="{{ current_brand_slug }}">
        {% endif %}
        {% if current_category_slug %}
            <input type="hidden" name="category" value="{{ current_category_slug }}">
        {% endif %}

        <!-- üîπ CATEGORY FILTER -->
        <div class="filter-section">
            <div class="filter-section-header">
                <span>Category</span>
                <span class="filter-chevron">‚ñæ</span>
            </div>

            <div class="brand-search">
                <input type="text"
                       id="categorySearchInput"
                       placeholder="Search categories..."
                       onkeyup="filterCategories()">
            </div>

            <div class="brand-filter-list" id="categoryFilterList">
                {% for category in categories %}
                    <button type="submit"
                            name="category"
                            value="{{ category.slug }}"
                            class="brand-filter-item {% if category.slug == current_category_slug %}active{% endif %}"
                            data-name="{{ category.name|lower }}">
                        {% if category.image %}
                            <img src="{{ category.image.url }}"
                                 alt="{{ category.name }}"
                                 class="brand-filter-thumb">
                        {% else %}
                            <img src="{% static 'images/category-default.png' %}"
                                 alt="{{ category.name }}"
                                 class="brand-filter-thumb">
                        {% endif %}
                        <span class="brand-filter-name">{{ category.name }}</span>
                    </button>
                {% endfor %}
            </div>

            {% if current_category_slug %}
                {% if current_brand_slug %}
                    <a href="?brand={{ current_brand_slug }}" class="clear-filter-link">Clear category filter</a>
                {% else %}
                    <a href="{% url 'product_list' %}" class="clear-filter-link">Clear category filter</a>
                {% endif %}
            {% endif %}
        </div>

        <!-- üîπ BRAND FILTER -->
        <div class="filter-section" style="margin-top: 16px;">
            <div class="filter-section-header">
                <span>Brand</span>
                <span class="filter-chevron">‚ñæ</span>
            </div>

            <div class="brand-search">
                <input type="text"
                       id="brandSearchInput"
                       placeholder="Search brands..."
                       onkeyup="filterBrands()">
            </div>

            <div class="brand-filter-list" id="brandFilterList">
                {% for brand in brands %}
                    <button type="submit"
                            name="brand"
                            value="{{ brand.slug }}"
                            class="brand-filter-item {% if brand.slug == current_brand_slug %}active{% endif %}"
                            data-name="{{ brand.name|lower }}">
                        {% if brand.image %}
                            <img src="{{ brand.image.url }}"
                                 alt="{{ brand.name }}"
                                 class="brand-filter-thumb">
                        {% else %}
                            <img src="{% static 'images/brand-default.png' %}"
                                 alt="{{ brand.name }}"
                                 class="brand-filter-thumb">
                        {% endif %}
                        <span class="brand-filter-name">{{ brand.name }}</span>
                    </button>
                {% endfor %}
            </div>

            {% if current_brand_slug %}
                {% if current_category_slug %}
                    <a href="?category={{ current_category_slug }}" class="clear-filter-link">Clear brand filter</a>
                {% else %}
                    <a href="{% url 'product_list' %}" class="clear-filter-link">Clear brand filter</a>
                {% endif %}
            {% endif %}
        </div>
    </form>

    <!-- ‚úÖ MOBILE FILTER DRAWER (uses SAME filters content) -->
    <div class="filters-overlay" id="filtersOverlay"></div>

    <div class="filters-drawer" id="filtersDrawer">
        <div class="filters-drawer-header">
            <div class="filters-drawer-title">Filters</div>
            <button class="filters-close" type="button" id="closeFilters" aria-label="Close">‚úï</button>
        </div>

        <form method="get" class="filters-card drawer-filters">
            <h2 class="filters-title">Filters</h2>

            {% if current_brand_slug %}
                <input type="hidden" name="brand" value="{{ current_brand_slug }}">
            {% endif %}
            {% if current_category_slug %}
                <input type="hidden" name="category" value="{{ current_category_slug }}">
            {% endif %}

            <!-- üîπ CATEGORY FILTER -->
            <div class="filter-section">
                <div class="filter-section-header">
                    <span>Category</span>
                    <span class="filter-chevron">‚ñæ</span>
                </div>

                <div class="brand-search">
                    <input type="text"
                           id="categorySearchInputDrawer"
                           placeholder="Search categories..."
                           onkeyup="filterCategoriesDrawer()">
                </div>

                <div class="brand-filter-list" id="categoryFilterListDrawer">
                    {% for category in categories %}
                        <button type="submit"
                                name="category"
                                value="{{ category.slug }}"
                                class="brand-filter-item {% if category.slug == current_category_slug %}active{% endif %}"
                                data-name="{{ category.name|lower }}">
                            {% if category.image %}
                                <img src="{{ category.image.url }}"
                                     alt="{{ category.name }}"
                                     class="brand-filter-thumb">
                            {% else %}
                                <img src="{% static 'images/category-default.png' %}"
                                     alt="{{ category.name }}"
                                     class="brand-filter-thumb">
                            {% endif %}
                            <span class="brand-filter-name">{{ category.name }}</span>
                        </button>
                    {% endfor %}
                </div>

                {% if current_category_slug %}
                    {% if current_brand_slug %}
                        <a href="?brand={{ current_brand_slug }}" class="clear-filter-link">Clear category filter</a>
                    {% else %}
                        <a href="{% url 'product_list' %}" class="clear-filter-link">Clear category filter</a>
                    {% endif %}
                {% endif %}
            </div>

            <!-- üîπ BRAND FILTER -->
            <div class="filter-section" style="margin-top: 16px;">
                <div class="filter-section-header">
                    <span>Brand</span>
                    <span class="filter-chevron">‚ñæ</span>
                </div>

                <div class="brand-search">
                    <input type="text"
                           id="brandSearchInputDrawer"
                           placeholder="Search brands..."
                           onkeyup="filterBrandsDrawer()">
                </div>

                <div class="brand-filter-list" id="brandFilterListDrawer">
                    {% for brand in brands %}
                        <button type="submit"
                                name="brand"
                                value="{{ brand.slug }}"
                                class="brand-filter-item {% if brand.slug == current_brand_slug %}active{% endif %}"
                                data-name="{{ brand.name|lower }}">
                            {% if brand.image %}
                                <img src="{{ brand.image.url }}"
                                     alt="{{ brand.name }}"
                                     class="brand-filter-thumb">
                            {% else %}
                                <img src="{% static 'images/brand-default.png' %}"
                                     alt="{{ brand.name }}"
                                     class="brand-filter-thumb">
                            {% endif %}
                            <span class="brand-filter-name">{{ brand.name }}</span>
                        </button>
                    {% endfor %}
                </div>

                {% if current_brand_slug %}
                    {% if current_category_slug %}
                        <a href="?category={{ current_category_slug }}" class="clear-filter-link">Clear brand filter</a>
                    {% else %}
                        <a href="{% url 'product_list' %}" class="clear-filter-link">Clear brand filter</a>
                    {% endif %}
                {% endif %}
            </div>
        </form>
    </div>

    <!-- ========== PRODUCTS AREA ========== -->
    <section class="products-area">
        <h1 class="page-title">Products</h1>
        <p class="page-subtitle">Browse all available products below.</p>

        <!-- ‚úÖ Mobile toolbar (like your screenshot) -->
        <div class="mobile-toolbar">
            <a class="pill {% if not current_brand_slug and not current_category_slug %}active{% endif %}"
               href="{% url 'product_list' %}">All</a>

            <div class="mobile-toolbar-actions">
                <button class="icon-btn" type="button" id="sortBtn" aria-label="Sort">‚áÖ</button>
                <button class="icon-btn" type="button" id="openFilters" aria-label="Filters">‚ö≤</button>
            </div>
        </div>

        <div class="product-grid">
            {% for product in products %}
                <div class="product-card">
                    <a href="{% url 'product_detail' product.id %}" class="product-link">
                        <div class="product-image-wrapper">
                            {% if product.image %}
                                <img src="{{ product.image.url }}" alt="{{ product.name }}">
                            {% else %}
                                <div class="no-image">No Image</div>
                            {% endif %}
                        </div>
                        <div class="product-name">{{ product.name }}</div>
                    </a>

                    {% if product.brand %}
                        <div class="product-brand"><strong>Brand:</strong> {{ product.brand.name }}</div>
                    {% endif %}
                    <div class="product-price">{{ product.price }} KD</div>
                    <div class="product-stock">In stock: {{ product.stock }}</div>

                    {% if request.user.is_authenticated %}
                        <form method="post" action="{% url 'add_to_cart' product.id %}" class="add-to-cart-form">
                            {% csrf_token %}
                            <label for="qty_{{ product.id }}">Qty:</label>
                            <input type="number" name="quantity" id="qty_{{ product.id }}" value="1" min="1">
                            <button type="submit" class="btn-cart">Add to Cart</button>
                        </form>
                    {% else %}
                        <a href="{% url 'login' %}" class="btn-secondary login-btn">Login to Add to Cart</a>
                    {% endif %}

                    {% if request.user.is_staff %}
                        <div class="product-admin-actions" style="margin-top:8px;">
                            <a href="{% url 'product_edit' product.id %}"
                               class="btn-small btn-secondary"
                               style="display: block; width: 100%; text-align: center;">
                                ‚úèÔ∏è Edit Product
                            </a>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p>No products found.</p>
            {% endfor %}
        </div>
    </section>

</div>

<script>
/* Desktop search */
function filterBrands() {
    const input = document.getElementById("brandSearchInput");
    const filter = input.value.toLowerCase();
    const items = document.querySelectorAll("#brandFilterList .brand-filter-item");
    items.forEach(item => item.style.display = item.dataset.name.includes(filter) ? "flex" : "none");
}
function filterCategories() {
    const input = document.getElementById("categorySearchInput");
    const filter = input.value.toLowerCase();
    const items = document.querySelectorAll("#categoryFilterList .brand-filter-item");
    items.forEach(item => item.style.display = item.dataset.name.includes(filter) ? "flex" : "none");
}

/* Drawer search */
function filterBrandsDrawer() {
    const input = document.getElementById("brandSearchInputDrawer");
    const filter = input.value.toLowerCase();
    const items = document.querySelectorAll("#brandFilterListDrawer .brand-filter-item");
    items.forEach(item => item.style.display = item.dataset.name.includes(filter) ? "flex" : "none");
}
function filterCategoriesDrawer() {
    const input = document.getElementById("categorySearchInputDrawer");
    const filter = input.value.toLowerCase();
    const items = document.querySelectorAll("#categoryFilterListDrawer .brand-filter-item");
    items.forEach(item => item.style.display = item.dataset.name.includes(filter) ? "flex" : "none");
}

/* Drawer open/close */
(function () {
    const openBtn = document.getElementById("openFilters");
    const closeBtn = document.getElementById("closeFilters");
    const drawer = document.getElementById("filtersDrawer");
    const overlay = document.getElementById("filtersOverlay");

    function openDrawer() {
        drawer?.classList.add("is-open");
        overlay?.classList.add("is-open");
    }
    function closeDrawer() {
        drawer?.classList.remove("is-open");
        overlay?.classList.remove("is-open");
    }

    openBtn?.addEventListener("click", openDrawer);
    closeBtn?.addEventListener("click", closeDrawer);
    overlay?.addEventListener("click", closeDrawer);
})();
</script>

{% endblock %}
